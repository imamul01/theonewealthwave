rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ðŸ”§ Utility Functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(firestore.default)/documents/admins/$(request.auth.uid));
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidImage() {
      return request.resource.contentType.matches('image/.*');
    }
    
    function isValidDocument() {
      return request.resource.contentType.matches('image/.*|application/pdf|application/msword|application/vnd.openxmlformats-officedocument.wordprocessingml.document');
    }
    
    function isValidSize(maxSizeMB) {
      return request.resource.size <= maxSizeMB * 1024 * 1024;
    }

    // ðŸ” User Profile Files
    match /users/{userId}/{allPaths=**} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) && 
        isValidDocument() && 
        isValidSize(5);
    }

    // ðŸ“ Deposit Screenshots
    match /deposits/{userId}/{fileName} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId) && 
        isValidImage() && 
        isValidSize(5);
      allow delete: if isOwner(userId) || isAdmin();
    }

    // ðŸ–¼ï¸ Profile Pictures
    match /profile-pics/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId) && 
        isValidImage() && 
        isValidSize(5);
      allow delete: if isOwner(userId) || isAdmin();
    }

    // ðŸ“„ KYC Documents
    match /kyc/{userId}/{fileName} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId) && 
        isValidDocument() && 
        isValidSize(10);
      allow delete: if isOwner(userId) || isAdmin();
    }

    // ðŸ“‹ Support Ticket Attachments
    match /support-attachments/{userId}/{ticketId}/{fileName} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId) && 
        isValidDocument() && 
        isValidSize(5);
      allow delete: if isOwner(userId) || isAdmin();
    }

    // ðŸ“Š Reports and Analytics
    match /reports/{userId}/{fileName} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isAdmin() && 
        request.resource.contentType.matches('application/pdf|application/vnd.ms-excel|application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') && 
        isValidSize(10);
      allow delete: if isAdmin();
    }

    // ðŸŽ¯ Training Materials
    match /training/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() && 
        request.resource.contentType.matches('application/pdf|image/.*|video/.*') && 
        isValidSize(50);
      allow delete: if isAdmin();
    }

    // ðŸ“¢ Announcements and News
    match /announcements/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() && 
        request.resource.contentType.matches('image/.*|application/pdf') && 
        isValidSize(5);
      allow delete: if isAdmin();
    }

    // ðŸ† Rewards and Certificates
    match /rewards/{userId}/{fileName} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isAdmin() && 
        request.resource.contentType.matches('image/.*|application/pdf') && 
        isValidSize(5);
      allow delete: if isAdmin();
    }

    // ðŸ“ˆ ROI and Income Reports
    match /income-reports/{userId}/{fileName} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isAdmin() && 
        request.resource.contentType.matches('application/pdf|application/vnd.ms-excel|application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') && 
        isValidSize(10);
      allow delete: if isAdmin();
    }

    // ðŸ”’ Private Documents
    match /private/{userId}/{fileName} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId) && 
        isValidDocument() && 
        isValidSize(10);
      allow delete: if isOwner(userId) || isAdmin();
    }

    // ðŸŒ Public Assets
    match /public/{fileName} {
      allow read: if true;
      allow write: if isAdmin() && 
        request.resource.contentType.matches('image/.*|application/pdf|text/.*') && 
        isValidSize(2);
      allow delete: if isAdmin();
    }

    // ðŸ“± App Assets (logos, icons, etc.)
    match /assets/{fileName} {
      allow read: if true;
      allow write: if isAdmin() && 
        request.resource.contentType.matches('image/.*|text/.*|application/json') && 
        isValidSize(1);
      allow delete: if isAdmin();
    }

    // ðŸ”„ Temporary Files
    match /temp/{userId}/{fileName} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) && 
        isValidSize(5);
      allow delete: if isOwner(userId);
    }

    // ðŸ“ Backup Files
    match /backups/{userId}/{fileName} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isAdmin() && 
        request.resource.contentType.matches('application/zip|application/x-rar-compressed|application/octet-stream') && 
        isValidSize(100);
      allow delete: if isAdmin();
    }

    // ðŸŽ¨ Custom Themes and Styles
    match /themes/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() && 
        request.resource.contentType.matches('text/css|application/json|image/.*') && 
        isValidSize(1);
      allow delete: if isAdmin();
    }

    // ðŸ“‹ Forms and Templates
    match /templates/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() && 
        request.resource.contentType.matches('application/pdf|application/vnd.ms-excel|application/vnd.openxmlformats-officedocument.spreadsheetml.sheet|text/html') && 
        isValidSize(5);
      allow delete: if isAdmin();
    }

    // ðŸ” Admin Only Files
    match /admin/{fileName} {
      allow read, write, delete: if isAdmin();
    }

    // ðŸš« Default Deny Rule - Must be last
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
} 